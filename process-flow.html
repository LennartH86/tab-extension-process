<!-- process-flow.html -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Flow Extension</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="./lib/tableau.extensions.1.latest.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            position: relative;
            background: #ffffff;
        }

        .toolbar {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            padding: 8px;
            border-radius: 12px;
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.12);
            z-index: 1000;
        }

        .toolbar button {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #1d1d1f;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            font-weight: 400;
        }

        .toolbar button:hover {
            background: rgba(0, 0, 0, 0.04);
            transform: scale(1.05);
        }

        .toolbar button:active {
            transform: scale(0.95);
            transition: all 0.1s ease;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 0;
            background: rgba(0, 0, 0, 0.04);
            border-radius: 8px;
            padding: 2px;
        }

        .zoom-level {
            min-width: 52px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            padding: 6px 8px;
            background: white;
            border-radius: 6px;
            margin: 0 2px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #canvas:active {
            cursor: grabbing;
        }

        .process-node-group {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-node-group:hover {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .connection-line {
            fill: none;
            stroke-width: 2;
            transition: all 0.2s ease;
        }

        .connection-line.success {
            stroke: #4a6b7c;
            marker-end: url(#arrowhead-success);
        }

        .connection-line.failure {
            stroke: #b85a73;
            stroke-dasharray: 6,4;
            marker-end: url(#arrowhead-failure);
        }

        .connection-line.continuation {
            stroke: #aea9a4;
            stroke-dasharray: 4,3;
            marker-end: url(#arrowhead-continuation);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 17px;
            font-weight: 400;
            color: #1d1d1f;
            text-align: center;
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            color: #1d1d1f;
            padding: 24px;
            border-radius: 16px;
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            max-width: 320px;
            text-align: center;
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.12);
            font-size: 15px;
            line-height: 1.4;
        }

        .configure-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.12);
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            max-width: 320px;
        }

        .configure-prompt h3 {
            margin-bottom: 8px;
            color: #1d1d1f;
            font-size: 19px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .configure-prompt p {
            margin-bottom: 24px;
            color: #86868b;
            line-height: 1.5;
            font-size: 15px;
            font-weight: 400;
        }

        .configure-btn {
            background: #4a6b7c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.15s ease;
            letter-spacing: -0.01em;
        }

        .configure-btn:hover {
            background: #3d5a6a;
            transform: translateY(-1px);
        }

        .configure-btn:active {
            transform: scale(0.98);
            transition: all 0.1s ease;
        }

        .node-tooltip {
            position: absolute;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: saturate(180%) blur(20px);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 400;
            pointer-events: none;
            z-index: 2000;
            display: none;
            max-width: 200px;
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">Initializing extension...</div>
        
        <div class="configure-prompt" id="configurePrompt" style="display: none;">
            <h3>Configuration Required</h3>
            <p>Please configure the extension to select the worksheet containing your process data.</p>
            <button class="configure-btn" onclick="openConfigureDialog()">Configure Extension</button>
        </div>
        
        <div class="toolbar" id="toolbar" style="display: none;">
            <button onclick="resetView()">üè†</button>
            <div class="zoom-controls">
                <button onclick="zoomOut()">‚àí</button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button onclick="zoomIn()">+</button>
            </div>
            <button onclick="refreshData()">üîÑ</button>
            <button onclick="openConfigureDialog()">‚öôÔ∏è</button>
        </div>
        
        <svg id="canvas" viewBox="0 0 1000 800" style="display: none;">
            <defs>
                <marker id="arrowhead-success" markerWidth="8" markerHeight="8" 
                        refX="7" refY="4" orient="auto">
                    <path d="M 0 0 L 8 4 L 0 8 z" fill="#4a6b7c"/>
                </marker>
                <marker id="arrowhead-failure" markerWidth="8" markerHeight="8" 
                        refX="7" refY="4" orient="auto">
                    <path d="M 0 0 L 8 4 L 0 8 z" fill="#b85a73"/>
                </marker>
                <marker id="arrowhead-continuation" markerWidth="8" markerHeight="8" 
                        refX="7" refY="4" orient="auto">
                    <path d="M 0 0 L 8 4 L 0 8 z" fill="#d4935a"/>
                </marker>
                <filter id="subtleShadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.08"/>
                </filter>
            </defs>
        </svg>
        
        <div class="node-tooltip" id="tooltip"></div>
    </div>

    <script>
        let currentZoom = 1;
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let panOffset = { x: 0, y: 0 };
        let processData = [];
        let dashboard;
        let selectedWorksheet = null;

        $(document).ready(function() {
            console.log('Document ready, initializing extension...');
            
            if (typeof tableau === 'undefined') {
                showError('Tableau Extensions API not loaded. Please ensure you are running this from within Tableau.');
                return;
            }

            tableau.extensions.initializeAsync({ 'configure': configure }).then(function() {
                console.log('Extension initialized successfully');
                dashboard = tableau.extensions.dashboardContent.dashboard;
                
                const worksheetName = tableau.extensions.settings.get('selectedWorksheet');
                console.log('Saved worksheet name:', worksheetName);
                
                if (worksheetName) {
                    selectedWorksheet = dashboard.worksheets.find(function(ws) {
                        return ws.name === worksheetName;
                    });
                    if (selectedWorksheet) {
                        console.log('Found worksheet, loading data...');
                        loadProcessData();
                    } else {
                        console.log('Worksheet not found, showing configure prompt');
                        showConfigurePrompt();
                    }
                } else {
                    console.log('No worksheet configured, showing configure prompt');
                    showConfigurePrompt();
                }
            }, function(err) {
                console.error('Initialization error:', err);
                showError('Error initializing extension: ' + err.toString());
            });
        });

        function configure() {
            openConfigureDialog();
        }

        function openConfigureDialog() {
            console.log('Opening configuration dialog...');
            const popupUrl = 'https://lennarth86.github.io/tab-extension-process/process-flow-config.html';
            console.log('Dialog URL:', popupUrl);
            
            const currentSettings = {
                selectedWorksheet: tableau.extensions.settings.get('selectedWorksheet') || '',
                timestampColumn: tableau.extensions.settings.get('timestampColumn') || '',
                idColumn: tableau.extensions.settings.get('idColumn') || '',
                processColumn: tableau.extensions.settings.get('processColumn') || '',
                statusColumn: tableau.extensions.settings.get('statusColumn') || ''
            };

            console.log('Current settings:', currentSettings);

            tableau.extensions.ui.displayDialogAsync(popupUrl, JSON.stringify(currentSettings), { 
                height: 600, 
                width: 500 
            }).then(function(closePayload) {
                console.log('Dialog closed with payload:', closePayload);
                if (closePayload && closePayload !== 'cancelled') {
                    tableau.extensions.settings.saveAsync().then(function() {
                        console.log('Settings saved, reloading data...');
                        const worksheetName = tableau.extensions.settings.get('selectedWorksheet');
                        selectedWorksheet = dashboard.worksheets.find(function(ws) {
                            return ws.name === worksheetName;
                        });
                        if (selectedWorksheet) {
                            loadProcessData();
                        }
                    });
                }
            }).catch(function(error) {
                console.error('Configuration dialog error:', error);
                showError('Error opening configuration dialog: ' + error.toString());
            });
        }

        function showConfigurePrompt() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('configurePrompt').style.display = 'block';
        }

        function loadProcessData() {
            try {
                document.getElementById('configurePrompt').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = 'Loading process data...';

                if (!selectedWorksheet) {
                    showError('No worksheet selected. Please configure the extension.');
                    return;
                }

                selectedWorksheet.getSummaryDataAsync().then(function(dataTable) {
                    parseTableauData(dataTable);
                    renderDiagram();
                    hideLoading();
                }).catch(function(err) {
                    showError('Error loading data from worksheet: ' + err.toString());
                });

            } catch(err) {
                showError('Error loading data: ' + err.toString());
            }
        }

        function parseTableauData(dataTable) {
            const data = [];
            const columns = dataTable.columns;
            
            const timestampColName = tableau.extensions.settings.get('timestampColumn');
            const idColName = tableau.extensions.settings.get('idColumn');
            const processColName = tableau.extensions.settings.get('processColumn');
            const statusColName = tableau.extensions.settings.get('statusColumn');

            const timestampCol = columns.find(function(col) {
                return col.fieldName === timestampColName || 
                       col.fieldName.toLowerCase().includes('timestamp') ||
                       col.fieldName.toLowerCase().includes('time');
            });
            const idCol = columns.find(function(col) {
                return col.fieldName === idColName || 
                       col.fieldName.toLowerCase().includes('id');
            });
            const processCol = columns.find(function(col) {
                return col.fieldName === processColName || 
                       col.fieldName.toLowerCase().includes('process') ||
                       col.fieldName.toLowerCase().includes('step');
            });
            const statusCol = columns.find(function(col) {
                return col.fieldName === statusColName || 
                       col.fieldName.toLowerCase().includes('status');
            });

            if (!timestampCol || !idCol || !processCol) {
                showError('Required columns not found. Please configure the extension with the correct column names.');
                return;
            }

            dataTable.data.forEach(function(row) {
                const rowData = {
                    timestamp: row[timestampCol.index].value,
                    id: row[idCol.index].value,
                    process: row[processCol.index].value,
                    status: statusCol ? (row[statusCol.index].value || 'success') : 'success'
                };
                data.push(rowData);
            });

            processData = analyzeProcessData(data);
        }

        function analyzeProcessData(data) {
            const processOrder = [];
            const seenProcesses = new Set();
            
            data.forEach(function(row) {
                if (!seenProcesses.has(row.process)) {
                    processOrder.push(row.process);
                    seenProcesses.add(row.process);
                }
            });

            const processSteps = {};
            
            const sessions = {};
            data.forEach(function(row) {
                if (!sessions[row.id]) {
                    sessions[row.id] = {};
                }
                sessions[row.id][row.process] = row.status;
            });

            const totalRuns = Object.keys(sessions).length;
            let fullySuccessfulRuns = 0;

            Object.values(sessions).forEach(function(session) {
                let hasAnyFailure = false;
                processOrder.forEach(function(step) {
                    if (session[step] && (session[step] === 'failed' || session[step] === 'failure')) {
                        hasAnyFailure = true;
                    }
                });
                if (!hasAnyFailure) {
                    fullySuccessfulRuns++;
                }
            });
            
            processOrder.forEach(function(step, index) {
                const displayName = step.charAt(0).toUpperCase() + 
                    step.slice(1).replace(/([A-Z])/g, ' $1');
                
                processSteps[step] = {
                    id: step,
                    title: displayName,
                    successCount: 0,
                    failureCount: 0,
                    x: 300,
                    y: 200 + (index * 130),
                    type: 'normal'
                };
            });

            Object.values(sessions).forEach(function(session) {
                processOrder.forEach(function(step) {
                    if (session[step]) {
                        if (session[step] === 'failed' || session[step] === 'failure') {
                            processSteps[step].failureCount++;
                        } else {
                            processSteps[step].successCount++;
                        }
                    }
                });
            });

            const allSteps = [];
            
            allSteps.push({
                id: 'start',
                title: 'Process Start',
                successCount: totalRuns,
                failureCount: 0,
                x: 300,
                y: 70,
                type: 'start'
            });

            processOrder.forEach(function(step) {
                allSteps.push(processSteps[step]);
                if (processSteps[step].failureCount > 0) {
                    allSteps.push({
                        id: step + '-failed',
                        title: processSteps[step].title + ' Failed',
                        successCount: 0,
                        failureCount: processSteps[step].failureCount,
                        x: 550,
                        y: processSteps[step].y,
                        type: 'failure'
                    });
                }
            });

            const lastY = processOrder.length > 0 ? 200 + ((processOrder.length - 1) * 130) + 130 : 330;
            allSteps.push({
                id: 'success',
                title: 'Process Success',
                successCount: fullySuccessfulRuns,
                failureCount: 0,
                x: 300,
                y: lastY,
                type: 'end'
            });

            return allSteps;
        }

        function renderDiagram() {
            const canvas = document.getElementById('canvas');
            const defs = canvas.querySelector('defs');
            canvas.innerHTML = '';
            canvas.appendChild(defs);
            
            createConnections();
            
            processData.forEach(function(node) {
                createProcessNode(node);
            });

            setupPanZoom();
        }

        function createConnections() {
            const canvas = document.getElementById('canvas');
            
            const mainSteps = processData.filter(function(n) {
                return !n.id.includes('-failed') && n.id !== 'start' && n.id !== 'success';
            });
            const startNode = processData.find(function(n) {
                return n.id === 'start';
            });
            const successNode = processData.find(function(n) {
                return n.id === 'success';
            });
            
            if (startNode && mainSteps.length > 0) {
                createConnectionLine(startNode, mainSteps[0], 'success');
            }
            
            for (let i = 0; i < mainSteps.length - 1; i++) {
                createConnectionLine(mainSteps[i], mainSteps[i + 1], 'success');
            }
            
            if (mainSteps.length > 0 && successNode) {
                createConnectionLine(mainSteps[mainSteps.length - 1], successNode, 'success');
            }

            mainSteps.forEach(function(step, index) {
                const failNode = processData.find(function(n) {
                    return n.id === step.id + '-failed';
                });
                
                if (failNode) {
                    createConnectionLine(step, failNode, 'failure');
                    
                    if (index < mainSteps.length - 1) {
                        createConnectionLine(failNode, mainSteps[index + 1], 'continuation', failNode.failureCount);
                    }
                }
            });
        }

        function createConnectionLine(fromNode, toNode, type, count) {
            const canvas = document.getElementById('canvas');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            let pathData;
            if (type === 'failure') {
                pathData = 'M ' + (fromNode.x + 60) + ' ' + fromNode.y + ' L ' + (toNode.x - 60) + ' ' + toNode.y;
            } else if (type === 'continuation') {
                const midX = (fromNode.x + toNode.x) / 2;
                const curveY = fromNode.y + 50;
                pathData = 'M ' + fromNode.x + ' ' + (fromNode.y + 40) + ' Q ' + midX + ' ' + curveY + ' ' + (toNode.x - 60) + ' ' + toNode.y;
                
                if (count && count > 0) {
                    const labelX = midX;
                    const labelY = curveY;
                    
                    const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    labelBg.setAttribute('x', labelX - 16);
                    labelBg.setAttribute('y', labelY - 8);
                    labelBg.setAttribute('width', '32');
                    labelBg.setAttribute('height', '16');
                    labelBg.setAttribute('rx', '8');
                    labelBg.setAttribute('ry', '8');
                    labelBg.setAttribute('fill', '#ffffff');
                    labelBg.setAttribute('stroke', '#d4935a');
                    labelBg.setAttribute('stroke-width', '1');
                    
                    const countLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    countLabel.setAttribute('x', labelX);
                    countLabel.setAttribute('y', labelY + 3);
                    countLabel.setAttribute('text-anchor', 'middle');
                    countLabel.setAttribute('font-size', '11');
                    countLabel.setAttribute('font-weight', '600');
                    countLabel.setAttribute('fill', '#d4935a');
                    countLabel.textContent = count.toString();
                    
                    canvas.appendChild(labelBg);
                    canvas.appendChild(countLabel);
                }
            } else {
                pathData = 'M ' + fromNode.x + ' ' + (fromNode.y + 40) + ' L ' + toNode.x + ' ' + (toNode.y - 40);
            }
            
            path.setAttribute('d', pathData);
            path.setAttribute('class', 'connection-line ' + type);
            canvas.appendChild(path);
        }

        function createProcessNode(node) {
            const canvas = document.getElementById('canvas');
            
            const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            nodeGroup.setAttribute('class', 'process-node-group');
            nodeGroup.setAttribute('transform', 'translate(' + node.x + ',' + node.y + ')');
            nodeGroup.setAttribute('filter', 'url(#subtleShadow)');
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '-60');
            rect.setAttribute('y', '-40');
            rect.setAttribute('width', '120');
            rect.setAttribute('height', '80');
            rect.setAttribute('rx', '12');
            rect.setAttribute('ry', '12');
            
            let fillColor, strokeColor, strokeWidth = 0.5;
            
            switch(node.type) {
                case 'start':
                    fillColor = '#4a6b7c';
                    strokeColor = 'none';
                    strokeWidth = 0;
                    break;
                case 'failure':
                    fillColor = '#ffffff';
                    strokeColor = '#b85a73';
                    strokeWidth = 1;
                    break;
                case 'end':
                    fillColor = '#7a9b7f';
                    strokeColor = 'none';
                    strokeWidth = 0;
                    break;
                case 'normal':
                    fillColor = '#ffffff';
                    strokeColor = '#4a6b7c';
                    strokeWidth = 1;
                    break;
            }
            
            rect.setAttribute('fill', fillColor);
            if (strokeWidth > 0) {
                rect.setAttribute('stroke', strokeColor);
                rect.setAttribute('stroke-width', strokeWidth);
            }
            
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', '0');
            title.setAttribute('y', '-8');
            title.setAttribute('text-anchor', 'middle');
            title.setAttribute('font-size', '10');
            title.setAttribute('font-weight', '500');
            title.setAttribute('letter-spacing', '-0.01em');
            title.setAttribute('fill', '#1d1d1f');
            
            const words = node.title.split(' ');
            if (words.length > 2 || node.title.length > 12) {
                const midpoint = Math.ceil(words.length / 2);
                const line1 = words.slice(0, midpoint).join(' ');
                const line2 = words.slice(midpoint).join(' ');
                
                title.setAttribute('y', '-18');
                title.textContent = line1;
                
                if (line2) {
                    const title2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    title2.setAttribute('x', '0');
                    title2.setAttribute('y', '-6');
                    title2.setAttribute('text-anchor', 'middle');
                    title2.setAttribute('font-size', '10');
                    title2.setAttribute('font-weight', '500');
                    title2.setAttribute('letter-spacing', '-0.01em');
                    title2.setAttribute('fill', '#1d1d1f');
                    title2.textContent = line2;
                    nodeGroup.appendChild(title2);
                }
            } else {
                title.textContent = node.title;
            }
            
            const count = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            count.setAttribute('x', '0');
            count.setAttribute('y', '20');
            count.setAttribute('text-anchor', 'middle');
            count.setAttribute('font-size', '12');
            count.setAttribute('font-weight', '600');
            count.setAttribute('fill', '#1d1d1f');
            
            if (node.type === 'failure') {
                count.textContent = node.failureCount.toString();
            } else if (node.failureCount > 0 && node.type === 'normal') {
                count.textContent = node.successCount.toString() + '/' + (node.successCount + node.failureCount).toString();
            } else {
                count.textContent = node.successCount.toString();
            }
            
            nodeGroup.addEventListener('mouseenter', function() {
                rect.style.transform = 'scale(1.05)';
                rect.style.transition = 'transform 0.2s ease';
            });
            
            nodeGroup.addEventListener('mouseleave', function() {
                rect.style.transform = 'scale(1)';
            });
            
            nodeGroup.appendChild(rect);
            nodeGroup.appendChild(title);
            nodeGroup.appendChild(count);
            
            nodeGroup.addEventListener('mouseenter', function(e) {
                 showTooltip(e, node); 
            });
            nodeGroup.addEventListener('mouseleave', hideTooltip);
            
            canvas.appendChild(nodeGroup);
        }

        function showTooltip(e, node) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY - 10) + 'px';
            
            let content = '<strong>' + node.title + '</strong><br>';
            content += 'Success: ' + node.successCount + '<br>';
            if (node.failureCount > 0) {
                content += 'Failures: ' + node.failureCount + '<br>';
                const total = node.successCount + node.failureCount;
                const rate = ((node.successCount / total) * 100).toFixed(1);
                content += 'Success Rate: ' + rate + '%';
            }
            
            tooltip.innerHTML = content;
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function setupPanZoom() {
            const canvas = document.getElementById('canvas');
            canvas.addEventListener('mousedown', startPan);
            canvas.addEventListener('mousemove', pan);
            canvas.addEventListener('mouseup', endPan);
            canvas.addEventListener('mouseleave', endPan);
            canvas.addEventListener('wheel', zoom);
        }

        function startPan(e) {
            if (e.target.closest('.process-node-group')) return;
            isPanning = true;
            panStart = { x: e.clientX, y: e.clientY };
        }

        function pan(e) {
            if (!isPanning) return;
            const dx = e.clientX - panStart.x;
            const dy = e.clientY - panStart.y;
            panOffset.x += dx;
            panOffset.y += dy;
            updateTransform();
            panStart = { x: e.clientX, y: e.clientY };
        }

        function endPan() {
            isPanning = false;
        }

        function zoom(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            currentZoom *= delta;
            currentZoom = Math.max(0.3, Math.min(3, currentZoom));
            updateZoomLevel();
            updateTransform();
        }

        function zoomIn() {
            currentZoom *= 1.2;
            currentZoom = Math.min(3, currentZoom);
            updateZoomLevel();
            updateTransform();
        }

        function zoomOut() {
            currentZoom *= 0.8;
            currentZoom = Math.max(0.3, currentZoom);
            updateZoomLevel();
            updateTransform();
        }

        function resetView() {
            currentZoom = 1;
            panOffset = { x: 0, y: 0 };
            updateZoomLevel();
            updateTransform();
        }

        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function updateTransform() {
            const canvas = document.getElementById('canvas');
            const viewBox = (-panOffset.x / currentZoom) + ' ' + (-panOffset.y / currentZoom) + ' ' + (1000 / currentZoom) + ' ' + (800 / currentZoom);
            canvas.setAttribute('viewBox', viewBox);
        }

        function refreshData() {
            if (selectedWorksheet) {
                loadProcessData();
            }
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('canvas').style.display = 'block';
            document.getElementById('toolbar').style.display = 'flex';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('configurePrompt').style.display = 'none';
            document.getElementById('canvas').style.display = 'none';
            document.getElementById('toolbar').style.display = 'none';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = '<strong>Error:</strong><br>' + message;
            document.querySelector('.container').appendChild(errorDiv);
        }
    </script>
</body>
</html> 
               